<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anivers√°rios da Fam√≠lia</title>

  <style>
    :root {
      --bg-color: #1a1a2e;
      --card-color: #16213e;
      --primary-color: #0f3460;
      --secondary-color: #e94560;
      --font-color: #dcdce4;
      --font-color-secondary: #a7a7b1;
    }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--font-color);
      margin: 0;
      padding: 20px;
    }
    h1 {
      text-align: center;
      color: var(--font-color);
      font-size: 2.5em;
      margin-bottom: 30px;
      text-shadow: 0 0 10px var(--secondary-color);
    }
    .tabs {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 25px;
    }
    .tab {
      padding: 10px 20px;
      background: var(--primary-color);
      color: var(--font-color);
      cursor: pointer;
      border-radius: 20px;
      user-select: none;
      transition: all 0.3s ease;
      border: 1px solid var(--primary-color);
    }
    .tab:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }
    .tab.active {
      background: var(--secondary-color);
      font-weight: bold;
      box-shadow: 0 0 12px rgba(233, 69, 96, 0.7);
    }
    .controls {
      text-align: center;
      margin-bottom: 30px;
    }
    .controls button {
      margin: 8px;
      padding: 12px 20px;
      border: none;
      background-color: var(--primary-color);
      color: var(--font-color);
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .controls button:hover {
       background-color: var(--secondary-color);
    }
    .controls input {
      padding: 12px;
      font-size: 16px;
      width: 350px;
      max-width: 90%;
      background-color: var(--card-color);
      border: 1px solid var(--primary-color);
      border-radius: 20px;
      color: var(--font-color);
      margin-bottom: 10px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 25px;
      padding: 20px;
    }
    .card {
      background-color: var(--card-color);
      border-radius: 15px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.4);
      overflow: hidden;
      width: 280px;
      text-align: center;
      padding: 20px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 24px rgba(0,0,0,0.6);
    }
    .card img {
      width: 100%;
      height: 240px;
      object-fit: cover;
      object-position: center 35%;
      border-radius: 10px;
      border: 4px solid var(--secondary-color);
      margin-bottom: 15px;
    }
    .card .name {
      font-size: 1.4em;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    .card .birthday {
      font-size: 1.1em;
      color: var(--font-color-secondary);
      margin-bottom: 15px;
    }
    .card p {
      font-size: 0.95em;
      color: var(--font-color-secondary);
    }
    .card ul {
      list-style-type: none;
      padding: 0;
      color: var(--font-color-secondary);
    }
    .card .edit-btn {
      margin-top: 15px;
      padding: 8px 16px;
      background-color: var(--primary-color);
      color: var(--font-color);
      border: none;
      border-radius: 15px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .card .edit-btn:hover {
      background-color: var(--secondary-color);
    }
    .highlight {
      border: 2px solid var(--secondary-color);
      box-shadow: 0 0 15px rgba(233, 69, 96, 0.6);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      background-color: rgba(0,0,0,0.7);
      padding-top: 60px;
    }
    .modal-content {
      background-color: var(--card-color);
      margin: 5% auto;
      padding: 30px;
      border: 1px solid var(--secondary-color);
      width: 80%;
      max-width: 500px;
      border-radius: 15px;
    }
    .modal-content label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
    }
    .modal-content input[type="text"], .modal-content textarea {
      width: calc(100% - 24px);
      padding: 12px;
      margin-top: 5px;
      border-radius: 8px;
      border: 1px solid var(--primary-color);
      background-color: var(--bg-color);
      color: var(--font-color);
    }
     .modal-content input[type="file"] {
      display: none;
    }
    .modal-content .file-upload-label {
        display: inline-block;
        padding: 10px 15px;
        background-color: var(--primary-color);
        color: var(--font-color);
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
    }
     .modal-content .file-upload-label:hover {
        background-color: var(--secondary-color);
    }
    .modal-content textarea {
        resize: vertical;
        min-height: 80px;
    }
    #imagePreview {
        margin-top: 15px;
        max-width: 100%;
        max-height: 200px;
        border-radius: 10px;
        display: block;
        margin-left: auto;
        margin-right: auto;
    }
    .modal-buttons {
      margin-top: 20px;
      text-align: right;
    }
    .modal-buttons button {
      padding: 10px 20px;
      border-radius: 20px;
      border: none;
      cursor: pointer;
    }
    .save-btn {
      background-color: var(--secondary-color);
      color: var(--font-color);
    }
    .cancel-btn {
      background-color: #6c757d;
      color: var(--font-color);
      margin-left: 10px;
    }
  </style>
</head>
<body>
  <h1>Anivers√°rios da Fam√≠lia Vieiraüéâ</h1>

  <div class="tabs">
    <div class="tab active" data-tab="netos">Netos</div>
    <div class="tab" data-tab="avos">Av√≥s</div>
    <div class="tab" data-tab="filhos">Filhos</div>
    <div class="tab" data-tab="noras">Noras</div>
    <div class="tab" data-tab="genros">Genros</div>
  </div>

  <div class="controls">
    <input type="text" id="searchInput" placeholder="Buscar por nome..." />
    <br>
    <button id="aniversariosDoMes">Anivers√°rios do M√™s</button>
    <button id="proximoAniversario">Pr√≥ximo Anivers√°rio</button>
  </div>

  <div class="container" id="cardsContainer"></div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h2 id="modalTitle">Editar Membro</h2>
      <input type="hidden" id="editDocId">
      <input type="hidden" id="editCategoria">
      
      <img id="imagePreview" src="" alt="Pr√©-visualiza√ß√£o da foto">
      
      <label for="fileUpload" class="file-upload-label">Escolher Nova Foto</label>
      <input type="file" id="fileUpload" accept="image/*">

      <label for="editPreferencias">Prefer√™ncias:</label>
      <textarea id="editPreferencias"></textarea>
      <label for="editPresentes">Quer Ganhar (um por linha):</label>
      <textarea id="editPresentes"></textarea>
      <div class="modal-buttons">
        <button id="saveBtn" class="save-btn">Salvar</button>
        <button id="cancelBtn" class="cancel-btn">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
    import { getFirestore, collection, getDocs, onSnapshot, doc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-storage.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA3KF0lV5ebQrIvdf8aeN1ywAcWA5xvF9o",
      authDomain: "projeto-aniversarios-865-afc19.firebaseapp.com",
      projectId: "projeto-aniversarios-865-afc19",
      storageBucket: "projeto-aniversarios-865-afc19.firebasestorage.app",
      messagingSenderId: "489832529100",
      appId: "1:489832529100:web:52a165166a17b6a98bd669"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const storage = getStorage(app);

    let abaAtiva = 'netos';
    let dadosFamilia = {
        netos: [],
        avos: [],
        filhos: [],
        noras: [],
        genros: []
    };
    let newImageFile = null;

    async function migrarDadosIniciaisParaFirestore() {
      const familiaCol = collection(db, 'familia');
      const snapshot = await getDocs(familiaCol);
      if (!snapshot.empty) {
        console.log('Dados j√° existem no Firestore. Migra√ß√£o n√£o necess√°ria.');
        return;
      }
      
      console.log('Iniciando migra√ß√£o de dados para o Firestore...');
      const batch = writeBatch(db);

      const dadosIniciais = {
        netos: [
          { nome: 'Clarisse Vieira', data: '2004-11-04', foto: 'fotos/clarisse.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Andrew Gabriel Vieira', data: '2006-05-31', foto: 'fotos/gabriel.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Maria Gabriele Vieira', data: '2009-06-08', foto: 'fotos/gabriele.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Ryan Lucas Vieira', data: '2010-08-16', foto: 'fotos/ryan.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Eduardo Jorge Vieira', data: '2012-04-11', foto: 'fotos/eduardojorge.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Miguel Angelo Vieira', data: '2014-02-19', foto: 'fotos/miguelangelo.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Camisa de Time', 'T√™nis novo'] },
          { nome: 'Amarillis Vieira', data: '2014-05-04', foto: 'fotos/amarillis.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'J√∫lia Vieira', data: '2015-09-11', foto: 'fotos/julia.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Antonella Vieira', data: '2017-10-08', foto: 'fotos/antonella.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Alice Vieira', data: '2018-04-21', foto: 'fotos/alice.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Pedro Eduardo Vieira', data: '2020-03-03', foto: 'fotos/pedroeduardo.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Jos√© Ravi Vieira', data: '2020-09-14', foto: 'fotos/ravi.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] },
          { nome: 'Francisco Daniel Vieira', data: '2023-02-17', foto: 'fotos/francisco.jpeg', preferencias: 'M√∫sica cl√°ssica, Romances, V√¥lei', presentes: ['Fone Bluetooth', 'Livro da Colleen Hoover', 'T√™nis novo'] }
        ],
        avos: [
          { nome: 'Maria Vieira', data: '1958-08-22', foto: 'fotos/maria.jpeg', preferencias: 'Jardinagem, Poesia, Viagens', presentes: ['Livro de jardinagem', 'Ch√° especial', 'Vaso decorativo'] },
          { nome: 'Jos√© Vieira', data: '1959-05-02', foto: 'fotos/jose.jpeg', preferencias: 'Xadrez, Cinema cl√°ssico, Caminhadas', presentes: ['Rel√≥gio cl√°ssico', 'Livro de xadrez', 'Passeio no parque'] }
        ],
        filhos: [
          { nome: 'Gisele Vieira', data: '1980-08-24', foto: 'fotos/gisele.jpeg', preferencias: 'Yoga, Fotografia, Viagens', presentes: ['Tapete de yoga', 'C√¢mera compacta', 'Voucher de viagem'] },
          { nome: 'Glauco Vieira', data: '1983-03-27', foto: 'fotos/glauco.jpeg', preferencias: 'Futebol, Culin√°ria, M√∫sica', presentes: ['Camisa de time', 'Livro de receitas', 'Fones de ouvido'] },
          { nome: 'Renilson Vieira', data: '1984-09-19', foto: 'fotos/renilson.jpeg', preferencias: 'Futebol, Culin√°ria, M√∫sica', presentes: ['Camisa de time', 'Livro de receitas', 'Fones de ouvido'] },
          { nome: 'Rafael Vieira', data: '1987-01-13', foto: 'fotos/rafael.jpeg', preferencias: 'Futebol, Culin√°ria, M√∫sica', presentes: ['Camisa de time', 'Livro de receitas', 'Fones de ouvido'] },
          { nome: 'Renato Vieira', data: '1988-11-15', foto: 'fotos/renato.jpeg', preferencias: 'Futebol, Culin√°ria, M√∫sica', presentes: ['Camisa de time', 'Livro de receitas', 'Fones de ouvido'] },
          { nome: 'Grasiele Vieira', data: '1991-07-21', foto: 'fotos/grasiele.jpeg', preferencias: 'Yoga, Fotografia, Viagens', presentes: ['Tapete de yoga', 'C√¢mera compacta', 'Voucher de viagem'] }
        ],
        noras: [
          { nome: 'Elizangela Vieira', data: '1980-12-16', foto: 'fotos/elizangela.jpeg', preferencias: 'Culin√°ria, Leitura, Viagens', presentes: ['Cookbook', 'Vinho especial', 'Voucher SPA'] },
          { nome: 'Visilene Vieira', data: '1988-01-23', foto: 'fotos/visilene.jpeg', preferencias: 'Jardinagem, Artesanato', presentes: ['Kit jardinagem', 'Curso de artesanato', 'Vaso decorativo'] },
          { nome: 'Rayana Vieira', data: '1989-01-04', foto: 'fotos/rayana.jpeg', preferencias: 'Moda, M√∫sica, Cinema', presentes: ['Cart√£o-presente loja', 'Fones de ouvido', 'Ingressos de cinema'] }
        ],
        genros: [
          { nome: 'Eduardo de Souza', data: '1983-12-11', foto: 'fotos/eduardo_souza.jpeg', preferencias: 'Tecnologia, Ciclismo', presentes: ['Acess√≥rio para bike', 'Powerbank', 'Livro de tecnologia'] }
        ]
      };

      for (const categoria in dadosIniciais) {
        dadosIniciais[categoria].forEach(membro => {
          const docRef = doc(collection(db, 'familia'));
          batch.set(docRef, { ...membro, categoria: categoria });
        });
      }
      
      await batch.commit();
      console.log('Migra√ß√£o conclu√≠da com sucesso!');
    }

    async function carregarDados() {
      await migrarDadosIniciaisParaFirestore();

      onSnapshot(collection(db, 'familia'), snapshot => {
        for (const key in dadosFamilia) {
            dadosFamilia[key] = [];
        }

        snapshot.forEach(doc => {
            const membro = { id: doc.id, ...doc.data() };
            if (membro.categoria && dadosFamilia[membro.categoria]) {
                dadosFamilia[membro.categoria].push(membro);
            }
        });
        console.log("Dados carregados do Firestore:", dadosFamilia);
        trocarAba(abaAtiva);
      });
    }

    function trocarAba(aba) {
      abaAtiva = aba;
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab[data-tab="${aba}"]`).classList.add('active');
      exibirMembros();
    }
    
    function calcularIdade(dataNascimento) {
      const hoje = new Date();
      const [ano, mes, dia] = dataNascimento.split('-').map(Number);
      const dataNasc = new Date(ano, mes - 1, dia);
      let idade = hoje.getFullYear() - dataNasc.getFullYear();
      const m = hoje.getMonth() - dataNasc.getMonth();
      if (m < 0 || (m === 0 && hoje.getDate() < dia)) {
        idade--;
      }
      return idade;
    }

    function criarCard(membro) {
      const hoje = new Date();
      const [ano, mes, dia] = membro.data.split('-').map(Number);
      const dataNasc = new Date(ano, mes - 1, dia);
      const idade = calcularIdade(membro.data);
      
      const card = document.createElement('div');
      card.className = `card ${dataNasc.getMonth() === hoje.getMonth() ? 'highlight' : ''}`;
      card.id = `card-${membro.id}`;
      card.innerHTML = `
          <img src="${membro.foto}" alt="Foto de ${membro.nome}" onerror="this.src='https://i.pravatar.cc/150?u=${membro.nome}'">
          <div class="name">${membro.nome}</div>
          <div class="birthday">${dataNasc.toLocaleDateString('pt-BR', { day: '2-digit', month: 'long' })} - ${idade} anos</div>
          <p><strong>Prefer√™ncias:</strong><br>${membro.preferencias || 'N√£o informado'}</p>
          <p><strong>Quer ganhar:</strong></p>
          <ul>
            ${membro.presentes && membro.presentes.length > 0 ? membro.presentes.map(p => `<li>- ${p}</li>`).join('') : '<li>N√£o informado</li>'}
          </ul>
          <button class="edit-btn">Editar</button>
      `;
      card.querySelector('.edit-btn').addEventListener('click', () => abrirModal(membro));
      return card;
    }

    function exibirMembros(lista = null) {
      const filtro = document.getElementById('searchInput').value.toLowerCase();
      const container = document.getElementById('cardsContainer');
      container.innerHTML = '';
      
      let listaBase = lista || dadosFamilia[abaAtiva];
      if (!listaBase) return;

      let listaParaExibir = listaBase.filter(m => m.nome.toLowerCase().includes(filtro));

      if (!lista) {
        const agora = new Date();
        agora.setHours(0,0,0,0);
        listaParaExibir.sort((a, b) => {
            const dateA = new Date(a.data);
            const dateB = new Date(b.data);
            dateA.setFullYear(agora.getFullYear());
            dateB.setFullYear(agora.getFullYear());
            if (dateA < agora) dateA.setFullYear(agora.getFullYear() + 1);
            if (dateB < agora) dateB.setFullYear(agora.getFullYear() + 1);
            return dateA - dateB;
        });
      }
      
      listaParaExibir.forEach(membro => {
        container.appendChild(criarCard(membro));
      });
    }

    function abrirModal(membro) {
        if (!membro) return;
        newImageFile = null;

        document.getElementById('modalTitle').innerText = `Editar ${membro.nome}`;
        document.getElementById('editDocId').value = membro.id;
        document.getElementById('editCategoria').value = membro.categoria;
        document.getElementById('imagePreview').src = membro.foto;
        document.getElementById('editPreferencias').value = membro.preferencias || '';
        document.getElementById('editPresentes').value = membro.presentes ? membro.presentes.join('\n') : '';
        document.getElementById('editModal').style.display = 'block';
    }

    function fecharModal() {
        document.getElementById('editModal').style.display = 'none';
        newImageFile = null; // Limpa o arquivo ao fechar
    }
    
    async function salvarAlteracoes() {
        const saveBtn = document.getElementById('saveBtn');
        saveBtn.disabled = true;
        saveBtn.innerText = 'Salvando...';

        const docId = document.getElementById('editDocId').value;
        const categoria = document.getElementById('editCategoria').value;
        
        let fotoUrl = dadosFamilia[categoria].find(m => m.id === docId).foto;

        if (newImageFile) {
            const storageRef = ref(storage, `fotos/${docId}_${newImageFile.name}`);
            try {
                const snapshot = await uploadBytes(storageRef, newImageFile);
                fotoUrl = await getDownloadURL(snapshot.ref);
                console.log('Upload conclu√≠do, URL:', fotoUrl);
            } catch (error) {
                console.error("Erro no upload da imagem: ", error);
                alert('Ocorreu um erro ao salvar a nova foto.');
                saveBtn.disabled = false;
                saveBtn.innerText = 'Salvar';
                return;
            }
        }
        
        const dadosAtualizados = {
            foto: fotoUrl,
            preferencias: document.getElementById('editPreferencias').value,
            presentes: document.getElementById('editPresentes').value.split('\n').filter(p => p.trim() !== '')
        };
        
        try {
          await updateDoc(doc(db, 'familia', docId), dadosAtualizados);
          console.log("Documento atualizado com sucesso!");
          fecharModal();
        } catch (error) {
          console.error("Erro ao atualizar documento: ", error);
          alert('Ocorreu um erro ao salvar as informa√ß√µes.');
        } finally {
            saveBtn.disabled = false;
            saveBtn.innerText = 'Salvar';
        }
    }

    function handleFileSelect(event) {
        newImageFile = event.target.files[0];
        if (newImageFile) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
            }
            reader.readAsDataURL(newImageFile);
        }
    }
    
    function ordenarPorMes() {
        const mesAtual = new Date().getMonth();
        const todasListas = Object.values(dadosFamilia).flat();
        const listaMes = todasListas.filter(m => new Date(m.data).getMonth() === mesAtual)
                                    .sort((a,b) => new Date(a.data).getDate() - new Date(b.data).getDate());
        if(listaMes.length === 0) alert('Nenhum anivers√°rio este m√™s.');
        else exibirMembros(listaMes);
    }
    
    function mostrarProximoAniversario() {
        const agora = new Date();
        agora.setHours(0,0,0,0);
        const todasListas = Object.values(dadosFamilia).flat();
        
        todasListas.sort((a, b) => {
            const dateA = new Date(a.data);
            const dateB = new Date(b.data);
            dateA.setFullYear(agora.getFullYear());
            dateB.setFullYear(agora.getFullYear());
            if (dateA < agora) dateA.setFullYear(agora.getFullYear() + 1);
            if (dateB < agora) dateB.setFullYear(agora.getFullYear() + 1);
            return dateA - dateB;
        });

        if(todasListas.length > 0) exibirMembros([todasListas[0]]);
        else alert('Nenhum pr√≥ximo anivers√°rio encontrado.');
    }
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => trocarAba(tab.dataset.tab));
    });
    document.getElementById('searchInput').addEventListener('input', () => exibirMembros());
    document.getElementById('aniversariosDoMes').addEventListener('click', ordenarPorMes);
    document.getElementById('proximoAniversario').addEventListener('click', mostrarProximoAniversario);
    document.getElementById('saveBtn').addEventListener('click', salvarAlteracoes);
    document.getElementById('cancelBtn').addEventListener('click', fecharModal);
    document.getElementById('fileUpload').addEventListener('change', handleFileSelect);

    window.onload = carregarDados;

  </script>
</body>
</html>